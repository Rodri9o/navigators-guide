---
# Setting up nginx and other deps
- name: Configure nginx service
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    mode: 0644
  notify: restart nginx

- name: Get active sites
  shell: ls -1 /etc/nginx/sites-enabled
  register: active

- name: Disable unwanted sites
  file:
    path: "/etc/nginx/sites-enabled/{{ item }}"
    state: absent
  with_items: "{{ active.stdout_lines }}"
  when: item != server_name

- name: Configure server block
  template:
    src: server-block.conf.j2
    dest: "/etc/nginx/sites-available/{{ server_name }}"
    mode: 0644

- name: Enable new site
  file:
    src: "/etc/nginx/sites-available/{{ server_name }}"
    dest: "/etc/nginx/sites-enabled/{{ server_name }}"
    state: link
  notify: restart nginx
